@model List<ProductManager.Models.CartItem>
@using System.Globalization

<h2>購物車</h2>

@if (!Model.Any())
{
    <p>購物車是空的。</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>商品</th>
                <th>單價</th>
                <th>數量</th>
                <th>小計</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-id="@item.ProductId">
                    <td>@item.Name</td>
                    <td>@item.Price.ToString("C0", CultureInfo.CreateSpecificCulture("zh-TW"))</td>
                    <td>
                        <input type="number" class="quantity-input" value="@item.Quantity" min="0" style="width:60px;" />
                    </td>
                    <td class="item-total">@((item.Price * item.Quantity).ToString("C0", CultureInfo.CreateSpecificCulture("zh-TW")))</td>
                    <td>
                        <a asp-controller="Cart" asp-action="Remove" asp-route-id="@item.ProductId" class="btn btn-danger btn-sm">刪除</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h4>總金額: <span id="totalAmount">@Model.Sum(c => c.Price * c.Quantity).ToString("C0", CultureInfo.CreateSpecificCulture("zh-TW"))</span></h4>
    <a asp-controller="Cart" asp-action="Clear" class="btn btn-warning">清空購物車</a>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            $('.quantity-input').on('change', function () {
                var row = $(this).closest('tr');
                var id = row.data('id');
                var quantity = $(this).val();

                $.ajax({
                    url: '@Url.Action("UpdateQuantityAjax", "Cart")',
                    type: 'POST',
                    data: { id: id, quantity: quantity },
                    success: function (res) {
                        if (res.success) {
                            row.find('.item-total').text('NT$' + res.itemTotal.toFixed(0));
                            $('#totalAmount').text('NT$' + res.totalAmount.toFixed(0));
                        }
                    }
                });
            });
        });
    </script>
}
